<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTrack - Dashboard</title>
  <link rel="stylesheet" href="vvvg.css">
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="hamburgr.css">
  <link rel = "stylesheet" href = "dash.css"></link>
  <!-- <link rel="stylesheet" href="backgroundstyle.css"> o-->
</head>
<body>
  
  <nav class="nav">
    <div class="hamburger-menu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>
    
    <div class="sidebar-overlay"></div>
    
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="profile.html" class="profile-link">
                <img src="pngtree-avatar-icon-profile-icon-member-login-vector-isolated-png-image_5247852.jpg" alt="Profile" class="profile-icon">
            </a>
            <div class="close-btn">&times;</div>
        </div>
        <div class="sidebar-content">
            <a href="index.html">Home</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="learn-more-html.html">Learn More</a>

            
            
            
            
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
            
            
            

            


            <a href="customer_support.html">Contact Us</a>
            <a href="#" id="logout-btn" style="display: none;" class="nav-link" onclick="logout()">Log Out</a>
        </div>
    </div>
    
    <script src="hmg.js"></script>

    <div class="logo">FinTrack</div>
    <div class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="dashboard.html" class="nav-link">Dashboard</a>
        <a href="signin.html" id="auth-link" style="display: none;" class="nav-link">Sign In</a>
    </div>
</nav>


  <script src = "auth.js"></script>
  <section class="dashboard-container">
    <div class="dashboard-header">
      <h1>Your Financial Dashboard</h1>
      <p  style="color: rgb(22, 21, 21);">Welcome back, User! Here's your financial overview.</p>

    </div>

    <div class="dashboard-summary">
      <div class="summary-card">
        <h3>Total Balance</h3>
        <p id = "balance" class="amount"></p>
      </div>
      <div class="summary-card">
        <h3>Monthly Income</h3>
        <p id = "income" class="amount"></p>
      </div>
      <div class="summary-card">
        <h3>Monthly Expenses</h3>
        <p id = "expense" class="amount"></p>
      </div>
      <div class="summary-card">
        <h3>Savings Rate</h3>
        <p id = "savings" class="amount"></p>
      </div>
    </div>

    <div class="dashboard-row">
      <div class="chart-container half">
        <div class="chart-header">
          <h3>Expense Breakdown</h3>
        </div>
        <div class="card">
                <h2 class="card-title">Spending by Category</h2>
                <div class="chart-container">
                    <canvas id="category-chart"></canvas>
                </div>
            </div>
      </div>
    </div>
<div class="dashboard-row">
    <div class="reminders-container half">
        <div class="container-header">
            <h3>Upcoming Bills</h3>
        </div>
        <div class="reminders-list">
            <!-- Bills will be dynamically inserted here by JavaScript -->
            <p style="color: grey;">Loading upcoming bills...</p>
        </div>
    </div>
</div>
    <!-- New buttons section after upcoming bills -->
    <div class="dashboard-row feature-buttons">
      <button class="feature-btn bill-btn">
        <span class="btn-icon">ðŸ“…</span>
        <span class="btn-text">Bills & Notifications</span>
      </button>
      <button class="feature-btn chatbot-btn">
        <span class="btn-icon">ðŸ’¬</span>
        <span class="btn-text">Finance Assistant</span>
      </button>
    </div>

  </section>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-column">
        <h4>Product</h4>
        <ul>
          <li><a href="#">Features</a></li>
          <li><a href="#">Pricing</a></li>
          <li><a href="#">Mobile App</a></li>
          <li><a href="#">Browser Extension</a></li>
          <li><a href="#">Roadmap</a></li>
        </ul>
      </div>
      
      <div class="footer-column">
        <h4>Company</h4>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Press Kit</a></li>
          <li><a href="#">Blog</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
      
      <div class="footer-column">
        <h4>Resources</h4>
        <ul>
          <li><a href="#">Help Center</a></li>
          <li><a href="#">Community</a></li>
          <li><a href="#">Financial Guides</a></li>
          <li><a href="#">API Documentation</a></li>
          <li><a href="#">Security</a></li>
        </ul>
      </div>
      
      <div class="footer-column">
        <h4>Connect With Us</h4>
        <p>Subscribe to our newsletter for tips, updates, and financial wisdom.</p>
        <div class="social-icons">
          <a href="#" class="social-icon">X</a>
          <a href="#" class="social-icon">F</a>
          <a href="#" class="social-icon">I</a>
          <a href="#" class="social-icon">L</a>
        </div>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>Â© 2025 FinTrack. All rights reserved.</p>
      <p style="margin-top: 8px;">
        <a href="#" style="margin-right: 16px;">Privacy Policy</a>
        <a href="#" style="margin-right: 16px;">Terms of Service</a>
        <a href="#">Cookie Settings</a>
      </p>
    </div>
  </footer>
<script>
document.addEventListener("DOMContentLoaded", async function () {
    let transactions = [];
    let categoryChart = null; // Declare the chart globally
    const gt = parseFloat(localStorage.getItem("monthlyincome")) || 0;

    const inc = document.getElementById("income");
    const bal = document.getElementById("balance");
    if (inc && bal) {
        inc.innerText = `$${gt.toFixed(2)}`;
        bal.innerText = `$${gt.toFixed(2)}`;
    }

    async function fetchTransactions() {
        try {
            const userEmail = localStorage.getItem("userEmail");
            if (!userEmail) throw new Error("User email not found");

            const response = await fetch(`https://my-backend-api-erp6.onrender.com/api/get-transactions?userEmail=${encodeURIComponent(userEmail)}`);
            if (!response.ok) throw new Error("Failed to fetch transactions.");
            
            const trans = await response.json();
            transactions = trans.map(({ userEmail, ...t }) => ({ ...t, id: t._id }));

            console.log("Transactions:", transactions);

                updateTotalExpenses();
                updateChart();
        } catch (error) {
            console.error("Error fetching transactions:", error);
        }
    }

    function updateTotalExpenses() {
    let sum = transactions.reduce((acc, t) => acc + Math.abs(t.amount), 0);
    document.getElementById("expense").innerText = `$${sum.toFixed(2)}`;

    let y = gt - sum;  // Fix: Use gt instead of inc
    bal.innerText = `$${y.toFixed(2)}`;

    let savingsPercentage = gt > 0 ? ((gt - sum) / gt) * 100 : 0;
    document.getElementById("savings").innerText = `${savingsPercentage.toFixed(2)} %`;
}


    function updateChart() {
                // Group by category and sum amounts
                const categoryData = {};

                transactions.forEach(transaction => {
                    // Include all transaction types
                    const category = transaction.category;
                    const amount = Math.abs(transaction.amount);

                    if (categoryData[category]) {
                        categoryData[category] += amount;
                    } else {
                        categoryData[category] = amount;
                    }
                });

                // Check if we have any data to display
                if (Object.keys(categoryData).length === 0) {
                    // If no data, show a placeholder
                    categoryChart.data.labels = ['No transaction data'];
                    categoryChart.data.datasets[0].data = [1];
                    categoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    const labels = Object.keys(categoryData);
                    const data = Object.values(categoryData);

                    // Update chart data
                    categoryChart.data.labels = labels;
                    categoryChart.data.datasets[0].data = data;
                    categoryChart.data.datasets[0].backgroundColor = [
                        '#0066cc', '#0080ff', '#66b3ff', '#2997ff', '#0056b3',
                        '#e0e0e0', '#86868b', '#6c757d', '#003366', '#002b4d'
                    ].slice(0, labels.length);
                }

                // Update the chart
                categoryChart.update();
            }

    await fetchTransactions();
    const remindersList = document.querySelector(".reminders-list");

    try {
       const userEmail = localStorage.getItem("userEmail"); // Retrieve user email
        if (!userEmail) {
            console.error("User email not found in localStorage.");
            return;
        }

        const response = await fetch(`https://my-backend-api-erp6.onrender.com/api/get-upcoming-bills?userEmail=${encodeURIComponent(userEmail)}`);
        
        if (!response.ok) {
            throw new Error("Failed to fetch upcoming bills.");
        }

        const bills = await response.json();

        // Clear existing content
        remindersList.innerHTML = "";

        if (bills.length === 0) {
            remindersList.innerHTML = "<p>No upcoming bills.</p>";
            return;
        }
        
        // Create bill items dynamically
        bills.forEach((bill) => {
            const billItem = document.createElement("div");
            billItem.classList.add("reminder-item");

            // Convert UTC to Indian Standard Time (IST)
            const dueDate = new Date(bill.dueDate).toLocaleDateString("en-IN", {
                day: "numeric",
                month: "long",
                year: "numeric",
                timeZone: "Asia/Kolkata", // Ensures IST time
            });

            billItem.innerHTML = `
                <p><strong>${bill.name}</strong></p>
                <p>Amount: â‚¹${bill.amount}</p>
                <p>Due: ${dueDate}</p>
            `;

            remindersList.appendChild(billItem);
        });
    } catch (error) {
        console.error("Error fetching bills:", error);
        remindersList.innerHTML = "<p>Error loading upcoming bills.</p>";
    }

});

</script>


</body>
</html>
